name: kernel-compatibility-matrix

on:
  workflow_dispatch:
  schedule:
    - cron: "15 5 * * 1"

permissions:
  contents: read
  actions: read

jobs:
  runner-discovery:
    runs-on: ubuntu-latest
    outputs:
      count_5_15: ${{ steps.detect.outputs.count_5_15 }}
      count_6_8: ${{ steps.detect.outputs.count_6_8 }}
    steps:
      - id: detect
        env:
          RUNNER_STATUS_TOKEN: ${{ secrets.RUNNER_STATUS_TOKEN }}
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          token="${RUNNER_STATUS_TOKEN:-${GITHUB_TOKEN:-}}"
          if [[ -z "$token" ]]; then
            echo "count_5_15=0" >> "$GITHUB_OUTPUT"
            echo "count_6_8=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          api_url="https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/runners?per_page=100"
          tmp_body="$(mktemp)"
          http_code="$(curl -sS -o "$tmp_body" -w "%{http_code}" \
            -H "Authorization: Bearer ${token}" \
            -H "Accept: application/vnd.github+json" \
            "$api_url" || true)"
          if [[ "$http_code" != "200" ]]; then
            echo "runner API unavailable (http=${http_code:-error}); marking profiles unavailable"
            echo "count_5_15=0" >> "$GITHUB_OUTPUT"
            echo "count_6_8=0" >> "$GITHUB_OUTPUT"
            rm -f "$tmp_body"
            exit 0
          fi
          body="$(cat "$tmp_body")"
          rm -f "$tmp_body"
          count_5_15="$(jq '[.runners[] | select(.status=="online") | select(any(.labels[]?; (.name|ascii_downcase)=="self-hosted")) | select(any(.labels[]?; (.name|ascii_downcase)=="linux")) | select(any(.labels[]?; (.name|ascii_downcase)=="ebpf")) | select(any(.labels[]?; (.name|ascii_downcase)=="kernel-5-15"))] | length' <<<"$body")"
          count_6_8="$(jq '[.runners[] | select(.status=="online") | select(any(.labels[]?; (.name|ascii_downcase)=="self-hosted")) | select(any(.labels[]?; (.name|ascii_downcase)=="linux")) | select(any(.labels[]?; (.name|ascii_downcase)=="ebpf")) | select(any(.labels[]?; (.name|ascii_downcase)=="kernel-6-8"))] | length' <<<"$body")"
          echo "count_5_15=${count_5_15}" >> "$GITHUB_OUTPUT"
          echo "count_6_8=${count_6_8}" >> "$GITHUB_OUTPUT"

  compat-kernel-5-15:
    needs: runner-discovery
    if: needs.runner-discovery.outputs.count_5_15 != '0'
    runs-on: [self-hosted, linux, ebpf, kernel-5-15]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: Probe compatibility profile
        run: |
          mkdir -p artifacts/compatibility
          ./scripts/ci/kernel_compat_probe.sh --profile kernel-5-15 --out artifacts/compatibility/kernel-5-15.json
      - uses: actions/upload-artifact@v4
        with:
          name: kernel-compat-kernel-5-15
          path: artifacts/compatibility/kernel-5-15.json

  compat-kernel-5-15-unavailable:
    needs: runner-discovery
    if: needs.runner-discovery.outputs.count_5_15 == '0'
    runs-on: ubuntu-latest
    steps:
      - name: Emit unavailable profile marker
        run: |
          mkdir -p artifacts/compatibility
          cat > artifacts/compatibility/kernel-5-15.json <<EOF
          {
            "profile": "kernel-5-15",
            "status": "unavailable",
            "detail": "no online self-hosted linux+ebpf runner with label kernel-5-15",
            "timestamp_utc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
      - uses: actions/upload-artifact@v4
        with:
          name: kernel-compat-kernel-5-15
          path: artifacts/compatibility/kernel-5-15.json

  compat-kernel-6-8:
    needs: runner-discovery
    if: needs.runner-discovery.outputs.count_6_8 != '0'
    runs-on: [self-hosted, linux, ebpf, kernel-6-8]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: Probe compatibility profile
        run: |
          mkdir -p artifacts/compatibility
          ./scripts/ci/kernel_compat_probe.sh --profile kernel-6-8 --out artifacts/compatibility/kernel-6-8.json
      - uses: actions/upload-artifact@v4
        with:
          name: kernel-compat-kernel-6-8
          path: artifacts/compatibility/kernel-6-8.json

  compat-kernel-6-8-unavailable:
    needs: runner-discovery
    if: needs.runner-discovery.outputs.count_6_8 == '0'
    runs-on: ubuntu-latest
    steps:
      - name: Emit unavailable profile marker
        run: |
          mkdir -p artifacts/compatibility
          cat > artifacts/compatibility/kernel-6-8.json <<EOF
          {
            "profile": "kernel-6-8",
            "status": "unavailable",
            "detail": "no online self-hosted linux+ebpf runner with label kernel-6-8",
            "timestamp_utc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
      - uses: actions/upload-artifact@v4
        with:
          name: kernel-compat-kernel-6-8
          path: artifacts/compatibility/kernel-6-8.json

  compatibility-report:
    needs:
      - compat-kernel-5-15
      - compat-kernel-5-15-unavailable
      - compat-kernel-6-8
      - compat-kernel-6-8-unavailable
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          pattern: kernel-compat-*
          merge-multiple: true
          path: artifacts/compatibility
      - name: Render compatibility report
        run: |
          RUN_ID="${{ github.run_id }}" ./scripts/ci/render_compatibility_report.sh artifacts/compatibility docs/compatibility.md
      - uses: actions/upload-artifact@v4
        with:
          name: kernel-compatibility-report
          path: |
            docs/compatibility.md
            artifacts/compatibility
