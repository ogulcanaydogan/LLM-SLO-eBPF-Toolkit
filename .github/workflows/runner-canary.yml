name: runner-canary

on:
  workflow_dispatch:
  schedule:
    - cron: "10 * * * *"

permissions:
  contents: read
  actions: read

jobs:
  runner-canary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Discover runner profiles
        env:
          RUNNER_STATUS_TOKEN: ${{ secrets.RUNNER_STATUS_TOKEN }}
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          mkdir -p artifacts/runner-canary
          ./scripts/ci/check_runner_profiles.sh \
            --profiles kernel-5-15,kernel-6-8 \
            --out artifacts/runner-canary/runner-discovery.json

          total="$(jq -r '.total_online_ebpf_runners // 0' artifacts/runner-canary/runner-discovery.json)"
          count_5_15="$(jq -r '.profiles["kernel-5-15"].count // 0' artifacts/runner-canary/runner-discovery.json)"
          count_6_8="$(jq -r '.profiles["kernel-6-8"].count // 0' artifacts/runner-canary/runner-discovery.json)"
          reason="$(jq -r '.reason // "unknown"' artifacts/runner-canary/runner-discovery.json)"

          echo "total_online_ebpf_runners=$total"
          echo "kernel_5_15_online=$count_5_15"
          echo "kernel_6_8_online=$count_6_8"
          echo "discovery_reason=$reason"

          if [[ "$total" -lt 1 ]]; then
            echo "::error::runner-canary: no online self-hosted linux+ebpf runners."
            exit 1
          fi

          if [[ "$count_5_15" -lt 1 ]]; then
            echo "::error::runner-canary: kernel-5-15 profile unavailable."
            exit 1
          fi

          if [[ "$count_6_8" -lt 1 ]]; then
            echo "::error::runner-canary: kernel-6-8 profile unavailable."
            exit 1
          fi
      - uses: actions/upload-artifact@v4
        with:
          name: runner-canary-${{ github.run_number }}
          path: artifacts/runner-canary/runner-discovery.json
          if-no-files-found: error
